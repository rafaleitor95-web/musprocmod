<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C√°mara Synth V8 (Definitiva)</title>
    <style>
        /* --- EST√âTICA PREMIUM --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #000; color: #fff; height: 100vh; margin: 0; overflow: hidden; touch-action: none; }
        
        /* PANTALLA DE INICIO */
        #startScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9000; transition: opacity 0.5s;
        }
        #startBtn {
            padding: 20px 40px; font-size: 1.5rem; background: transparent; color: #00d2ff;
            border: 3px solid #00d2ff; border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.3); transition: all 0.3s;
        }
        #startBtn:active { transform: scale(0.95); box-shadow: 0 0 40px rgba(0, 210, 255, 0.6); background: rgba(0, 210, 255, 0.1); }

        /* INTERFAZ PRINCIPAL */
        #mainUI { position: relative; width: 100%; height: 100%; display: none; /* Se activa al iniciar */ }

        #videoContainer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
        }
        video { width: 100%; height: 100%; object-fit: cover; filter: contrast(1.1) saturate(1.2); }
        
        /* Visualizador (La bolita de energ√≠a) */
        #visualizer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, #fff, transparent);
            opacity: 0; pointer-events: none; z-index: 10; transition: transform 0.1s, opacity 0.1s;
            mix-blend-mode: screen;
        }

        /* Bot√≥n Ajustes (Flotante) */
        #controlsBtnContainer { position: absolute; top: 20px; right: 20px; z-index: 50; }
        .glass-btn {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff; padding: 12px 20px; border-radius: 30px; cursor: pointer; font-weight: bold;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* PANEL SINTETIZADOR (Glassmorphism) */
        #synthPanel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 85%;
            background: rgba(10, 10, 18, 0.85); /* Transl√∫cido */
            border-top-left-radius: 25px; border-top-right-radius: 25px;
            padding: 25px; transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            z-index: 100; overflow-y: auto; display: flex; flex-direction: column; gap: 25px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        #synthPanel.open { transform: translateY(0); }

        /* Controles */
        .control-group { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .control-group h3 { margin: 0 0 20px 0; color: #00d2ff; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        .slider-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; font-size: 0.9rem; color: #ccc; }
        .slider-row span { width: 90px; }
        
        /* Sliders personalizados */
        input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: #00d2ff; border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px rgba(0, 210, 255, 0.5); border: 2px solid #fff; }

        /* Info superior */
        #topInfo { position: absolute; top: 25px; left: 25px; z-index: 5; text-shadow: 0 2px 4px rgba(0,0,0,0.8); pointer-events: none;}
        #modeLabel { font-weight: 800; font-size: 1.4rem; letter-spacing: 0.5px; }
        
        #pCanvas { display: none; } /* Oculto */
    </style>
</head>
<body>

    <div id="startScreen">
        <h1 style="color:#fff; margin-bottom: 30px; text-shadow: 0 0 20px #00d2ff;">C√ÅMARA SYNTH V8</h1>
        <button id="startBtn">INICIAR SISTEMA</button>
        <p style="color:#888; margin-top: 20px; font-size: 0.9rem;">Se requiere acceso a C√°mara y Audio</p>
    </div>

    <div id="mainUI">
        <div id="topInfo"><div id="modeLabel">Inicializando...</div></div>
        
        <div id="controlsBtnContainer">
            <button class="glass-btn" id="toggleSynthBtn">üéõÔ∏è Ajustes de Sonido</button>
        </div>
        
        <div id="videoContainer">
             <video id="video" autoplay playsinline webkit-playsinline muted></video>
             <div id="visualizer"></div>
        </div>

        <div id="synthPanel">
            <div style="display: flex; justify-content: space-between; align-items:center;">
                <h2 style="margin:0; font-weight: 300;">Sintetizador Pro</h2>
                <button class="glass-btn" id="closeSynthBtn" style="padding: 8px 15px; font-size: 0.9rem; background: rgba(255, 50, 50, 0.2); border-color: rgba(255,50,50,0.3);">‚úï Cerrar</button>
            </div>
            
            <div class="control-group">
                <h3>üåä Osciladores (Mezcla)</h3>
                <div class="slider-row"><span>Seno (Suave)</span><input type="range" id="volSine" max="100" value="80"></div>
                <div class="slider-row"><span>Tri√°ngulo</span><input type="range" id="volTri" max="100" value="10"></div>
                <div class="slider-row"><span>Cuadrada (Retro)</span><input type="range" id="volSqr" max="100" value="0"></div>
                <div class="slider-row"><span>Sierra (Agresiva)</span><input type="range" id="volSaw" max="100" value="5"></div>
            </div>

            <div class="control-group">
                <h3>üìà Envolvente y Filtro</h3>
                <div class="slider-row"><span>Ataque</span><input type="range" id="envAttack" min="1" max="100" value="15"></div>
                <div class="slider-row"><span>Release (Cola)</span><input type="range" id="envRelease" min="10" max="300" value="100"></div>
                <div class="slider-row"><span>Brillo (Filtro)</span><input type="range" id="filterCutoff" min="100" max="8000" value="2500"></div>
            </div>

            <div class="control-group">
                <h3>‚ú® Efectos Espaciales</h3>
                <div class="slider-row"><span>Reverb (Hall)</span><input type="range" id="fxReverb" max="100" value="40"></div>
                <div class="slider-row"><span>Delay (Eco)</span><input type="range" id="fxDelay" max="100" value="20"></div>
            </div>

             <div class="control-group" style="border-color: #00d2ff;">
                <h3 style="color: #fff;">üëÅÔ∏è Sensor de C√°mara</h3>
                <div class="slider-row"><span>Sensibilidad</span><input type="range" id="camSense" min="1" max="100" value="60"></div>
            </div>
            
            <div style="height: 60px;"></div> </div>
    </div>

    <canvas id="pCanvas" width="120" height="90"></canvas>

<script>
    // --- REFERENCIAS UI ---
    const startScreen = document.getElementById('startScreen');
    const startBtn = document.getElementById('startBtn');
    const mainUI = document.getElementById('mainUI');
    const synthPanel = document.getElementById('synthPanel');
    const modeLabel = document.getElementById('modeLabel');
    const videoContainer = document.getElementById('videoContainer');
    
    // --- VARIABLES GLOBALES DE AUDIO/VIDEO ---
    let audioCtx, masterGain, delayNode, delayFeedback, reverbNode, reverbGain;
    let video, pCtx, pCanvas;
    let prevFrame = null;
    let lastNoteTime = 0;

    // --- TEOR√çA MUSICAL (MODOS GRIEGOS) ---
    const ROOT = 261.63; // Do central (C4)
    const R=1, m2=1.059, M2=1.122, m3=1.189, M3=1.260, P4=1.335, d5=1.414, P5=1.498, m6=1.587, M6=1.682, m7=1.782, M7=1.888;
    const MODES = {
        IONIAN: { name: "J√≥nico (Mayor)", hex: '#ff4d4d', ratios: [R, M2, M3, P4, P5, M6, M7] },
        MIXOLYDIAN: { name: "Mixolidio", hex: '#ffaf40', ratios: [R, M2, M3, P4, P5, M6, m7] },
        LYDIAN: { name: "Lidio (Brillante)", hex: '#ffff4d', ratios: [R, M2, M3, d5, P5, M6, M7] },
        PHRYGIAN: { name: "Frigio (Ex√≥tico)", hex: '#4dff4d', ratios: [R, m2, m3, P4, P5, m6, m7] },
        DORIAN: { name: "D√≥rico", hex: '#4dd2ff', ratios: [R, M2, m3, P4, P5, M6, m7] },
        AEOLIAN: { name: "E√≥lico (Menor)", hex: '#4d4dff', ratios: [R, M2, m3, P4, P5, m6, m7] },
        LOCRIAN: { name: "Locrio (Tenso)", hex: '#af4dff', ratios: [R, m2, m3, P4, d5, m6, m7] }
    };
    let currentMode = MODES.IONIAN;

    // --- INICIALIZACI√ìN DEL SISTEMA (ROBUSTA) ---
    startBtn.addEventListener('click', async () => {
        startBtn.innerText = "Iniciando...";
        startBtn.disabled = true;

        try {
            // 1. Inicializar Audio (Debe ser tras gesto de usuario)
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            await audioCtx.resume();
            await initAudioGraph(); // Configurar efectos avanzados

            // 2. Inicializar C√°mara
            video = document.getElementById('video');
            pCanvas = document.getElementById('pCanvas');
            pCtx = pCanvas.getContext('2d', { willReadFrequently: true });

            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, // Intenta trasera, fallback a lo que haya
                audio: false 
            });
            video.srcObject = stream;

            // 3. Arrancar Loop cuando el video est√© listo
            video.onloadeddata = () => {
                startScreen.style.opacity = 0;
                setTimeout(() => startScreen.style.display = 'none', 500);
                mainUI.style.display = 'block';
                requestAnimationFrame(processLoop);
            };

        } catch (err) {
            alert("Error al iniciar: " + err.message + ". Verifica permisos y HTTPS.");
            startBtn.innerText = "Reintentar";
            startBtn.disabled = false;
        }
    });

    // --- CONFIGURACI√ìN DEL MOTOR DE AUDIO AVANZADO ---
    async function initAudioGraph() {
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.7;
        masterGain.connect(audioCtx.destination);

        // --- Efecto Delay (Eco) ---
        delayNode = audioCtx.createDelay();
        delayNode.delayTime.value = 0.35; // 350ms
        delayFeedback = audioCtx.createGain();
        delayFeedback.gain.value = 0.4;
        delayNode.connect(delayFeedback);
        delayFeedback.connect(delayNode);
        delayNode.connect(masterGain);

        // --- Efecto Reverb (Convoluci√≥n Sint√©tica) ---
        reverbNode = audioCtx.createConvolver();
        // Crear un impulso sint√©tico (ruido con decaimiento exponencial) para la reverb
        const duration = 2.5;
        const decay = 2.0;
        const length = audioCtx.sampleRate * duration;
        const impulse = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
        for (let i = 0; i < 2; i++) {
            const channel = impulse.getChannelData(i);
            for (let j = 0; j < length; j++) {
                // Ruido blanco * envolvente exponencial
                channel[j] = (Math.random() * 2 - 1) * Math.pow(1 - j / length, decay);
            }
        }
        reverbNode.buffer = impulse;
        reverbGain = audioCtx.createGain();
        reverbNode.connect(reverbGain);
        reverbGain.connect(masterGain);
    }

    // --- BUCLE DE PROCESAMIENTO VISUAL ---
    function processLoop(timestamp) {
        requestAnimationFrame(processLoop);
        // Limitar a ~30fps para no quemar la CPU del m√≥vil
        if (timestamp - lastNoteTime * 1000 < 33) return; 

        if (video.readyState === 4) {
            // Dibujar en canvas peque√±o para an√°lisis
            pCtx.drawImage(video, 0, 0, pCanvas.width, pCanvas.height);
            const data = pCtx.getImageData(0, 0, pCanvas.width, pCanvas.height).data;

            let motion = 0, rT=0, gT=0, bT=0, count=0;
            // Muestreo optimizado (saltar p√≠xeles)
            const step = 16; 
            for (let i = 0; i < data.length; i += step * 4) {
                rT+=data[i]; gT+=data[i+1]; bT+=data[i+2]; count++;
                // Detecci√≥n de movimiento simple en canal verde
                if (prevFrame && Math.abs(data[i+1] - prevFrame[i+1]) > 25) motion++;
            }
            prevFrame = data;

            // Actualizar Modo y UI
            detectMode(rT/count, gT/count, bT/count);
            modeLabel.innerText = currentMode.name;
            modeLabel.style.color = currentMode.hex;
            videoContainer.style.boxShadow = `inset 0 0 50px ${currentMode.hex}40`; // Luz ambiental en bordes

            // L√≥gica de disparo
            const senseUI = parseInt(document.getElementById('camSense').value);
            const threshold = (101 - senseUI) * 1.5; // Umbral din√°mico

            if (motion > threshold) {
                // Calcular intensidad normalizada (0.0 - 1.0)
                const intensity = Math.min(motion / (threshold * 6), 1);
                triggerSynth(intensity);
            }
        }
    }

    // --- EL SINTETIZADOR (PLAY NOTE) ---
    function triggerSynth(intensity) {
        const now = audioCtx.currentTime;
        // Evitar ametralladora de notas
        if (now - lastNoteTime < 0.1) return; 
        lastNoteTime = now;

        triggerVisualizer(intensity);

        // 1. Selecci√≥n de Nota
        const ratio = currentMode.ratios[Math.floor(Math.random() * currentMode.ratios.length)];
        let octave = 1;
        if (intensity > 0.6) octave = 2; // M√°s agudo si hay mucho movimiento
        else if (intensity < 0.25) octave = 0.5;
        const freq = ROOT * ratio * octave;

        // 2. Lectura de Par√°metros UI
        const vSine = parseInt(document.getElementById('volSine').value) / 100;
        const vTri = parseInt(document.getElementById('volTri').value) / 100;
        const vSqr = parseInt(document.getElementById('volSqr').value) / 100;
        const vSaw = parseInt(document.getElementById('volSaw').value) / 100;
        
        const atk = parseInt(document.getElementById('envAttack').value) / 100;
        const rel = parseInt(document.getElementById('envRelease').value) / 100 * 3; // Hasta 3 segundos
        const cutoff = parseInt(document.getElementById('filterCutoff').value);
        
        const sendReverb = parseInt(document.getElementById('fxReverb').value) / 100;
        const sendDelay = parseInt(document.getElementById('fxDelay').value) / 100;

        // 3. Construcci√≥n de la Voz (Cadena de Audio)
        const noteGain = audioCtx.createGain(); // VCA (Envolvente de amplitud)
        noteGain.gain.setValueAtTime(0, now);
        noteGain.gain.linearRampToValueAtTime(0.4, now + atk); // Ataque
        noteGain.gain.exponentialRampToValueAtTime(0.0001, now + atk + rel); // Release

        const filter = audioCtx.createBiquadFilter(); // VCF (Filtro)
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(cutoff, now);
        // El filtro se abre un poco con la intensidad del movimiento
        filter.frequency.linearRampToValueAtTime(cutoff + (intensity * 2000), now + atk);

        // 4. Osciladores (Aditivos)
        createOsc('sine', freq, vSine, now, atk+rel, noteGain);
        createOsc('triangle', freq, vTri, now, atk+rel, noteGain);
        createOsc('square', freq, vSqr, now, atk+rel, noteGain);
        createOsc('sawtooth', freq, vSaw, now, atk+rel, noteGain);

        // 5. Rutas de Se√±al
        noteGain.connect(filter);
        filter.connect(masterGain); // Se√±al seca (Dry)

        // Env√≠os a efectos (Wet)
        if (sendDelay > 0) {
            const dSend = audioCtx.createGain();
            dSend.gain.value = sendDelay;
            filter.connect(dSend);
            dSend.connect(delayNode);
        }
        if (sendReverb > 0) {
            const rSend = audioCtx.createGain();
            rSend.gain.value = sendReverb;
            filter.connect(rSend);
            rSend.connect(reverbNode);
        }
    }

    // Helper para crear osciladores
    function createOsc(type, f, v, t, d, dest) {
        if (v < 0.01) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.value = f; g.gain.value = v;
        o.connect(g); g.connect(dest);
        o.start(t); o.stop(t + d + 0.1);
    }

    // --- UTILIDADES ---
    function detectMode(r, g, b) {
        // L√≥gica HSL simplificada para estabilidad
        r/=255; g/=255; b/=255;
        const max = Math.max(r,g,b), min = Math.min(r,g,b);
        let h = (max+min)/2;
        if(max!==min) {
            const d = max-min;
            switch(max){ case r: h=(g-b)/d+(g<b?6:0); break; case g: h=(b-r)/d+2; break; case b: h=(r-g)/d+4; break; }
            h/=6;
        }
        const hue = h*360;
        // Asignaci√≥n a modos con solapamiento para evitar saltos bruscos
        if (hue>=340 || hue<25) currentMode=MODES.IONIAN;
        else if (hue>=25 && hue<60) currentMode=MODES.MIXOLYDIAN;
        else if (hue>=60 && hue<90) currentMode=MODES.LYDIAN;
        else if (hue>=90 && hue<160) currentMode=MODES.PHRYGIAN;
        else if (hue>=160 && hue<210) currentMode=MODES.DORIAN;
        else if (hue>=210 && hue<270) currentMode=MODES.AEOLIAN;
        else if (hue>=270 && hue<340) currentMode=MODES.LOCRIAN;
    }

    function triggerVisualizer(i) {
        const v = document.getElementById('visualizer');
        v.style.background = `radial-gradient(circle, #fff, ${currentMode.hex})`;
        v.style.opacity = 0.6 + (i * 0.4);
        v.style.transform = `translate(-50%, -50%) scale(${1 + i*2})`;
        setTimeout(() => { 
            v.style.opacity = 0; 
            v.style.transform = `translate(-50%, -50%) scale(0.5)`;
        }, 150);
    }

    // UI Listeners
    document.getElementById('toggleSynthBtn').onclick = () => synthPanel.classList.add('open');
    document.getElementById('closeSynthBtn').onclick = () => synthPanel.classList.remove('open');
</script>
</body>
</html>
