<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cam Synth V7 (Diagn√≥stico)</title>
    <style>
        body { font-family: monospace; background: #111; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Consola de Diagn√≥stico (Visible siempre al principio) */
        #consoleLog {
            background: #000; color: #0f0; border-bottom: 2px solid #fff;
            height: 150px; overflow-y: scroll; padding: 10px; font-size: 12px;
            z-index: 9999;
        }

        #uiContainer {
            flex-grow: 1; position: relative; display: flex; flex-direction: column;
            align-items: center; justify-content: center; background: #222;
        }

        /* Bot√≥n de inicio antibalas */
        #btnStart {
            background: #00d2ff; color: #000; font-size: 1.5rem; font-weight: bold;
            padding: 20px 40px; border: 4px solid #fff; border-radius: 20px;
            cursor: pointer; z-index: 50;
        }

        #videoContainer {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: none; /* Se muestra solo si carga la c√°mara */
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Visualizador */
        #visualizer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px; border-radius: 50%; background-color: white;
            opacity: 0; pointer-events: none; z-index: 10;
        }

        /* Bot√≥n Ajustes */
        #btnSettings {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            background: rgba(0,0,0,0.5); border: 1px solid #fff; color: #fff;
            padding: 10px; border-radius: 10px; display: none;
        }

        /* Panel Sintetizador */
        #synthPanel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 350px;
            background: rgba(20,20,30,0.95); z-index: 200;
            transform: translateY(110%); transition: transform 0.3s;
            padding: 15px; box-sizing: border-box; overflow-y: auto;
        }
        #synthPanel.open { transform: translateY(0); }
        
        input[type=range] { width: 100%; margin: 10px 0; }
        label { display: block; margin-top: 10px; color: #00d2ff; }
    </style>
</head>
<body>

    <div id="consoleLog">Iniciando sistema...<br></div>

    <div id="uiContainer">
        <button id="btnStart">üî¥ PULSA PARA INICIAR</button>
        
        <div id="videoContainer">
            <video id="video" autoplay playsinline webkit-playsinline muted></video>
            <div id="visualizer"></div>
        </div>
        
        <button id="btnSettings">‚öôÔ∏è Ajustes</button>
        
        <div id="synthPanel">
            <button onclick="document.getElementById('synthPanel').classList.remove('open')" style="float:right;">Cerrar</button>
            <h3>Sintetizador</h3>
            <label>Volumen Seno</label><input type="range" id="volSine" max="100" value="80">
            <label>Volumen Sierra</label><input type="range" id="volSaw" max="100" value="0">
            <label>Sensibilidad C√°mara</label><input type="range" id="camSense" min="1" max="100" value="50">
        </div>
    </div>
    
    <canvas id="pCanvas" style="display:none;" width="100" height="100"></canvas>

<script>
    // --- FUNCI√ìN DE LOG ---
    const consoleDiv = document.getElementById('consoleLog');
    function log(msg) {
        const line = document.createElement('div');
        line.textContent = `> ${msg}`;
        consoleDiv.appendChild(line);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        console.log(msg);
    }

    // --- VARIABLES ---
    const btnStart = document.getElementById('btnStart');
    const video = document.getElementById('video');
    const videoContainer = document.getElementById('videoContainer');
    const pCanvas = document.getElementById('pCanvas');
    const pCtx = pCanvas.getContext('2d', { willReadFrequently: true });
    
    let audioCtx;
    let lastNoteTime = 0;
    let prevData = null;

    // --- CHEQUEOS INICIALES ---
    window.onload = () => {
        log("P√°gina cargada.");
        
        // 1. Verificar HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            log("‚ùå ERROR CR√çTICO: NO ES HTTPS.");
            log("El m√≥vil bloquear√° la c√°mara.");
            alert("AVISO: Debes usar HTTPS (el candadito en la web) o la c√°mara no funcionar√°.");
        } else {
            log("‚úÖ Conexi√≥n Segura (HTTPS) o Localhost.");
        }

        // 2. Verificar soporte de medios
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            log("‚ùå ERROR: Tu navegador no soporta acceso a c√°mara.");
        } else {
            log("‚úÖ API de C√°mara detectada.");
        }
    };

    // --- CLICK DE INICIO ---
    btnStart.addEventListener('click', async () => {
        btnStart.disabled = true;
        btnStart.textContent = "Cargando...";
        log("Bot√≥n pulsado. Iniciando...");

        try {
            // PASO 1: AUDIO
            log("Intentando iniciar AudioContext...");
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            await audioCtx.resume();
            log(`‚úÖ Audio Activo. Estado: ${audioCtx.state}`);

            // PASO 2: C√ÅMARA
            log("Solicitando c√°mara (Modo Environment)...");
            
            // Intentamos configuraci√≥n relajada
            let constraints = { 
                audio: false, 
                video: { 
                    facingMode: 'environment' // Intenta trasera, si falla usa cualquiera
                } 
            };

            let stream;
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (e) {
                log("‚ö†Ô∏è Fall√≥ c√°mara trasera. Probando c√°mara gen√©rica...");
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            }

            log("‚úÖ Stream de video obtenido.");
            video.srcObject = stream;
            
            // PASO 3: REPRODUCCI√ìN
            video.onloadedmetadata = () => {
                log("‚úÖ Metadatos de video cargados.");
                video.play();
                videoContainer.style.display = 'block';
                btnStart.style.display = 'none';
                document.getElementById('btnSettings').style.display = 'block';
                
                log("üöÄ SISTEMA FUNCIONANDO. Procesando...");
                requestAnimationFrame(loop);
            };

        } catch (err) {
            log(`‚ùå ERROR FATAL: ${err.name} - ${err.message}`);
            alert(`Error: ${err.message}. Revisa los permisos del navegador.`);
            btnStart.disabled = false;
            btnStart.textContent = "Reintentar";
        }
    });

    // --- PROCESAMIENTO ---
    function loop() {
        if (video.readyState === 4) {
            pCtx.drawImage(video, 0, 0, 100, 100);
            const data = pCtx.getImageData(0,0,100,100).data;
            
            let motion = 0;
            let r=0, g=0, b=0, count=0;

            for(let i=0; i<data.length; i+=16) { // Muestreo r√°pido
                r+=data[i]; g+=data[i+1]; b+=data[i+2]; count++;
                if(prevData && Math.abs(data[i+1]-prevData[i+1])>20) motion++;
            }
            prevData = data;

            // Detectar Color (Simplificado)
            r/=255; g/=255; b/=255;
            let max = Math.max(r,g,b);
            let color = '#fff';
            // L√≥gica simple para V7
            if (r > g && r > b) color = '#ff3232'; // Rojo
            else if (g > r && g > b) color = '#32cd32'; // Verde
            else if (b > r && b > g) color = '#1e90ff'; // Azul
            else color = '#ffff00'; // Mezcla

            // Umbral
            const sense = document.getElementById('camSense').value;
            const umbral = (101 - sense) * 5;

            if (motion > umbral) {
                triggerSound(color, motion);
            }
        }
        requestAnimationFrame(loop);
    }

    function triggerSound(color, force) {
        if (!audioCtx) return;
        const now = audioCtx.currentTime;
        if (now - lastNoteTime < 0.15) return;
        lastNoteTime = now;

        // Visual
        const vis = document.getElementById('visualizer');
        vis.style.backgroundColor = color;
        vis.style.opacity = 1;
        vis.style.transform = "translate(-50%, -50%) scale(1.5)";
        setTimeout(()=> { vis.style.opacity = 0; vis.style.transform = "translate(-50%, -50%) scale(1)"; }, 100);

        // Audio
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        
        // Frecuencia aleatoria pentat√≥nica (simple)
        const notes = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25];
        const freq = notes[Math.floor(Math.random()*notes.length)];
        
        osc.frequency.value = freq * (force > 500 ? 2 : 1);
        osc.type = 'sine';
        
        // Mezcla simple
        const vSine = document.getElementById('volSine').value / 100;
        const vSaw = document.getElementById('volSaw').value / 100;

        if (vSaw > 0) osc.type = 'sawtooth'; // Simple switch for debug

        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.2, now + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);

        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.6);
    }

    // Botones UI
    document.getElementById('btnSettings').onclick = () => {
        document.getElementById('synthPanel').classList.add('open');
    };
</script>
</body>
</html>
